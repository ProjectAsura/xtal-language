#include "xtal.h"
#include "xtal_macro.h"

namespace xtal{

Exception::Exception(const AnyPtr& message){
	initialize(message);
}

void Exception::initialize(const AnyPtr& message){
	message_ = message->to_s();
	backtrace_ = xnew<Array>();
}

void Exception::append_backtrace(const AnyPtr& file, int_t line, const AnyPtr& function_name){
	backtrace_->push_back(Xf("\t%(file)s:%(line)d: in %(function_name)s")->call(
		Named(Xid(file), file), Named(Xid(line), line), Named(Xid(function_name), function_name)));
}

StringPtr Exception::to_s(){
	MemoryStreamPtr mm = xnew<MemoryStream>();
	mm->put_s(get_class()->object_name());
	mm->put_s(": ");
	mm->put_s(message_->to_s());
	mm->put_s("\n");
	mm->put_s(backtrace_->join("\n"));
	return mm->to_s();
}

AnyPtr cast_error(const AnyPtr& from, const AnyPtr& to){
	return builtin()->member(Xid(CastError))->call(Xt("Xtal Runtime Error 1004")->call(
		Named(Xid(type), from->get_class()->object_name()), Named(Xid(required), to)
	));
}

AnyPtr argument_error(const AnyPtr& object, int_t no){
	return builtin()->member(Xid(ArgumentError))->call(Xt("Xtal Runtime Error 1001")->call(
		Named(Xid(object), object), 
		Named(Xid(no), no)
	));
}

AnyPtr unsupported_error(const AnyPtr& target, const IDPtr& primary_key, const AnyPtr& secondary_key){

	IDPtr pick;

	if(const ClassPtr& klass = ptr_as<Class>(target)){
		pick = klass->find_near_member(primary_key, secondary_key);
		if(raweq(pick, primary_key)){
			pick = null;
		}
	}

	if(pick){
		if(secondary_key){
			return UnsupportedError()->call(Xt("Xtal Runtime Error 1021")->call(
				Named(Xid(object), Xf("%s::%s#%s")->call(target->object_name(), primary_key, secondary_key)),
				Named(Xid(pick), pick)
			));	
		}
		else{
			return UnsupportedError()->call(Xt("Xtal Runtime Error 1021")->call(
				Named(Xid(object), Xf("%s::%s")->call(target->object_name(), primary_key)),
				Named(Xid(pick), pick)
			));	
		}
	}
	else{
		if(secondary_key){
			return UnsupportedError()->call(Xt("Xtal Runtime Error 1015")->call(
				Named(Xid(object), Xf("%s::%s#%s")->call(target->object_name(), primary_key, secondary_key))
			));
		}
		else{
			return UnsupportedError()->call(Xt("Xtal Runtime Error 1015")->call(
				Named(Xid(object), Xf("%s::%s")->call(target->object_name(), primary_key))
			));		
		}
	}
}

namespace{
	void default_except_handler(const AnyPtr& except, const char* file, int line){
//#ifdef XTAL_NO_EXCEPTIONS
//		printf("%s(%d):%s\n", file, line, except->to_s()->c_str());
//		exit(1);
//#endif
	}

	except_handler_t except_handler_ = &default_except_handler;
	AnyPtr except_;
}


except_handler_t except_handler(){
	return except_handler_;
}

void set_except_handler(except_handler_t handler){
	except_handler_ = handler;
}


void initialize_except(){
	{
		ClassPtr p = new_cpp_class<Exception>();
		p->def(Xid(new), ctor<Exception>()->params(Xid(message), empty_id));
		p->method(Xid(initialize), &Exception::initialize)->params(Xid(message), empty_id);
		p->method(Xid(to_s), &Exception::to_s);
		p->method(Xid(message), &Exception::message);
		p->method(Xid(backtrace), &Exception::backtrace);
		p->method(Xid(append_backtrace), &Exception::append_backtrace);

		builtin()->def(Xid(Exception), p);
	}
}

void initialize_except_scrpt(){
	Xemb((

builtin::StandardError: class(Exception){}
builtin::RuntimeError: class(StandardError){}
builtin::IOError: class(StandardError){}
builtin::LogicError: class(StandardError){}
builtin::CastError: class(StandardError){}
builtin::ArgumentError: class(StandardError){}
builtin::YieldError: class(StandardError){}
builtin::InstanceVariableError: class(StandardError){}
builtin::UnsupportedError: class(StandardError){}
builtin::RedefinedError: class(StandardError){}
builtin::AccessibilityError: class(StandardError){}
builtin::AssertionFailed: class(StandardError){}
builtin::CompileError: class(StandardError){
initialize: method(message, errors:[]){
		Exception::initialize(%f"%s\n%s"(message, errors.join("\t\n")));
	}		
}

	),
"\x78\x74\x61\x6c\x01\x00\x00\x00\x00\x00\x01\x98\x39\x00\x01\x39\x00\x02\x81\x00\x00\x89\x00\x01\x00\x04\x25\x00\x01\x83\x00\x00\x00\x04\x00\x82\x37\x00\x05\x39\x00\x01\x39\x00\x05\x81\x00\x01\x89\x00\x02\x00\x04\x25\x00\x01\x83\x00\x00\x00\x04\x00\x82\x37"
"\x00\x07\x39\x00\x01\x39\x00\x05\x81\x00\x02\x89\x00\x03\x00\x04\x25\x00\x01\x83\x00\x00\x00\x04\x00\x82\x37\x00\x09\x39\x00\x01\x39\x00\x05\x81\x00\x03\x89\x00\x04\x00\x04\x25\x00\x01\x83\x00\x00\x00\x04\x00\x82\x37\x00\x0b\x39\x00\x01\x39\x00\x05\x81\x00"
"\x04\x89\x00\x05\x00\x04\x25\x00\x01\x83\x00\x00\x00\x04\x00\x82\x37\x00\x0d\x39\x00\x01\x39\x00\x05\x81\x00\x05\x89\x00\x06\x00\x04\x25\x00\x01\x83\x00\x00\x00\x04\x00\x82\x37\x00\x0f\x39\x00\x01\x39\x00\x05\x81\x00\x06\x89\x00\x07\x00\x04\x25\x00\x01\x83"
"\x00\x00\x00\x04\x00\x82\x37\x00\x11\x39\x00\x01\x39\x00\x05\x81\x00\x07\x89\x00\x08\x00\x04\x25\x00\x01\x83\x00\x00\x00\x04\x00\x82\x37\x00\x13\x39\x00\x01\x39\x00\x05\x81\x00\x08\x89\x00\x09\x00\x04\x25\x00\x01\x83\x00\x00\x00\x04\x00\x82\x37\x00\x15\x39"
"\x00\x01\x39\x00\x05\x81\x00\x09\x89\x00\x0a\x00\x04\x25\x00\x01\x83\x00\x00\x00\x04\x00\x82\x37\x00\x17\x39\x00\x01\x39\x00\x05\x81\x00\x0a\x89\x00\x0b\x00\x04\x25\x00\x01\x83\x00\x00\x00\x04\x00\x82\x37\x00\x19\x39\x00\x01\x39\x00\x05\x81\x00\x0b\x89\x00"
"\x0c\x00\x04\x25\x00\x01\x83\x00\x00\x00\x04\x00\x82\x37\x00\x1b\x39\x00\x01\x39\x00\x05\x81\x00\x0c\x89\x00\x0d\x00\x04\x25\x00\x01\x83\x00\x01\x00\x04\x00\x89\x00\x0e\x00\x2c\x53\x00\x00\x05\x84\x20\x00\x1d\x01\x28\x00\x01\x1d\x00\x2f\x01\x00\x01\x00\x00"
"\x20\x28\x00\x02\x2e\x02\x00\x01\x00\x39\x00\x02\x33\x00\x21\x2e\x01\x00\x00\x00\x25\x00\x01\x83\x00\x00\x00\x21\x00\x82\x37\x00\x22\x25\x00\x8b\x00\x0e\x0e\x00\x00\x00\x00\x00\x04\x00\x00\x00\x12\x00\x29\x00\x00\x00\x00\x00\x07\x00\x00\x00\x12\x00\x44\x00"
"\x00\x00\x00\x00\x09\x00\x00\x00\x12\x00\x5f\x00\x00\x00\x00\x00\x0b\x00\x00\x00\x12\x00\x7a\x00\x00\x00\x00\x00\x0d\x00\x00\x00\x12\x00\x95\x00\x00\x00\x00\x00\x0f\x00\x00\x00\x12\x00\xb0\x00\x00\x00\x00\x00\x11\x00\x00\x00\x12\x00\xcb\x00\x00\x00\x00\x00"
"\x13\x00\x00\x00\x12\x00\xe6\x00\x00\x00\x00\x00\x15\x00\x00\x00\x12\x00\x01\x01\x00\x00\x00\x00\x17\x00\x00\x00\x12\x00\x1c\x01\x00\x00\x00\x00\x19\x00\x00\x00\x12\x00\x37\x01\x00\x00\x00\x00\x1b\x00\x00\x00\x12\x00\x52\x01\x00\x00\x00\x00\x1e\x00\x00\x00"
"\x12\x00\x67\x01\x00\x00\x00\x01\x20\x00\x00\x00\x12\x00\x00\x0d\x06\x00\x00\x00\x01\x00\x03\x00\x01\x00\x7f\xc6\x04\x00\x00\x00\x01\xf4\x12\x00\x21\x00\x00\x00\x01\x00\x06\x00\x01\x00\x7f\xc6\x07\x00\x00\x00\x01\xf4\x12\x00\x3c\x00\x00\x00\x01\x00\x08\x00"
"\x01\x00\x7f\xc6\x09\x00\x00\x00\x01\xf4\x12\x00\x57\x00\x00\x00\x01\x00\x0a\x00\x01\x00\x7f\xc6\x0b\x00\x00\x00\x01\xf4\x12\x00\x72\x00\x00\x00\x01\x00\x0c\x00\x01\x00\x7f\xc6\x0d\x00\x00\x00\x01\xf4\x12\x00\x8d\x00\x00\x00\x01\x00\x0e\x00\x01\x00\x7f\xc6"
"\x0f\x00\x00\x00\x01\xf4\x12\x00\xa8\x00\x00\x00\x01\x00\x10\x00\x01\x00\x7f\xc6\x11\x00\x00\x00\x01\xf4\x12\x00\xc3\x00\x00\x00\x01\x00\x12\x00\x01\x00\x7f\xc6\x13\x00\x00\x00\x01\xf4\x12\x00\xde\x00\x00\x00\x01\x00\x14\x00\x01\x00\x7f\xc6\x15\x00\x00\x00"
"\x01\xf4\x12\x00\xf9\x00\x00\x00\x01\x00\x16\x00\x01\x00\x7f\xc6\x17\x00\x00\x00\x01\xf4\x12\x00\x14\x01\x00\x00\x01\x00\x18\x00\x01\x00\x7f\xc6\x19\x00\x00\x00\x01\xf4\x12\x00\x2f\x01\x00\x00\x01\x00\x1a\x00\x01\x00\x7f\xc6\x1b\x00\x00\x00\x01\xf4\x12\x00"
"\x4a\x01\x00\x00\x01\x00\x1c\x00\x02\x00\x7f\xc6\x1e\x00\x00\x00\x01\xc5\x43\x00\x00\x0f\x00\x00\x00\x00\x03\x06\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x0e\x00\x00\x00\x05\x00\x04\x00\x00\x00\x00\x00\x00\x01\x00\x00\x29\x00\x00\x00\x05\x00\x07\x00\x00\x00"
"\x00\x00\x00\x01\x00\x00\x44\x00\x00\x00\x05\x00\x09\x00\x00\x00\x00\x00\x00\x01\x00\x00\x5f\x00\x00\x00\x05\x00\x0b\x00\x00\x00\x00\x00\x00\x01\x00\x00\x7a\x00\x00\x00\x05\x00\x0d\x00\x00\x00\x00\x00\x00\x01\x00\x00\x95\x00\x00\x00\x05\x00\x0f\x00\x00\x00"
"\x00\x00\x00\x01\x00\x00\xb0\x00\x00\x00\x05\x00\x11\x00\x00\x00\x00\x00\x00\x01\x00\x00\xcb\x00\x00\x00\x05\x00\x13\x00\x00\x00\x00\x00\x00\x01\x00\x00\xe6\x00\x00\x00\x05\x00\x15\x00\x00\x00\x00\x00\x00\x01\x00\x00\x01\x01\x00\x00\x05\x00\x17\x00\x00\x00"
"\x00\x00\x00\x01\x00\x00\x1c\x01\x00\x00\x05\x00\x19\x00\x00\x00\x00\x00\x00\x01\x00\x00\x37\x01\x00\x00\x05\x00\x1b\x00\x00\x00\x00\x00\x00\x01\x00\x00\x52\x01\x00\x00\x05\x00\x1e\x00\x00\x00\x00\x00\x00\x01\x00\x00\x60\x01\x00\x00\x05\x00\x1e\x00\x02\x00"
"\x00\x00\x00\x01\x01\x02\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\x00\x00\x00\x14\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x1b\x00\x00\x00\x04\x00\x00\x00\x36\x00\x00\x00\x05\x00\x00\x00\x51\x00\x00\x00\x06\x00\x00\x00\x6c\x00"
"\x00\x00\x07\x00\x00\x00\x87\x00\x00\x00\x08\x00\x00\x00\xa2\x00\x00\x00\x09\x00\x00\x00\xbd\x00\x00\x00\x0a\x00\x00\x00\xd8\x00\x00\x00\x0b\x00\x00\x00\xf3\x00\x00\x00\x0c\x00\x00\x00\x0e\x01\x00\x00\x0d\x00\x00\x00\x29\x01\x00\x00\x0e\x00\x00\x00\x44\x01"
"\x00\x00\x13\x00\x00\x00\x44\x01\x00\x00\x0f\x00\x00\x00\x47\x01\x00\x00\x13\x00\x00\x00\x47\x01\x00\x00\x0f\x00\x00\x00\x5b\x01\x00\x00\x12\x00\x00\x00\x64\x01\x00\x00\x10\x00\x00\x00\x67\x01\x00\x00\x12\x00\x00\x00\x67\x01\x00\x00\x11\x00\x00\x00\x88\x01"
"\x00\x00\x12\x00\x00\x00\x92\x01\x00\x00\x13\x00\x00\x00\x95\x01\x00\x00\x14\x00\x00\x00\x00\x01\x0b\x00\x00\x00\x03\x09\x00\x00\x00\x06\x73\x6f\x75\x72\x63\x65\x09\x00\x00\x00\x11\x74\x6f\x6f\x6c\x2f\x74\x65\x6d\x70\x2f\x69\x6e\x2e\x78\x74\x61\x6c\x09\x00"
"\x00\x00\x0b\x69\x64\x65\x6e\x74\x69\x66\x69\x65\x72\x73\x0a\x00\x00\x00\x23\x09\x00\x00\x00\x00\x09\x00\x00\x00\x07\x62\x75\x69\x6c\x74\x69\x6e\x09\x00\x00\x00\x09\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\x09\x00\x00\x00\x0c\x5f\x69\x6e\x69\x74\x69\x61\x6c\x69"
"\x7a\x65\x5f\x02\x00\x00\x00\x09\x09\x00\x00\x00\x0d\x53\x74\x61\x6e\x64\x61\x72\x64\x45\x72\x72\x6f\x72\x02\x00\x00\x00\x09\x09\x00\x00\x00\x0c\x52\x75\x6e\x74\x69\x6d\x65\x45\x72\x72\x6f\x72\x02\x00\x00\x00\x09\x09\x00\x00\x00\x07\x49\x4f\x45\x72\x72\x6f"
"\x72\x02\x00\x00\x00\x09\x09\x00\x00\x00\x0a\x4c\x6f\x67\x69\x63\x45\x72\x72\x6f\x72\x02\x00\x00\x00\x09\x09\x00\x00\x00\x09\x43\x61\x73\x74\x45\x72\x72\x6f\x72\x02\x00\x00\x00\x09\x09\x00\x00\x00\x0d\x41\x72\x67\x75\x6d\x65\x6e\x74\x45\x72\x72\x6f\x72\x02"
"\x00\x00\x00\x09\x09\x00\x00\x00\x0a\x59\x69\x65\x6c\x64\x45\x72\x72\x6f\x72\x02\x00\x00\x00\x09\x09\x00\x00\x00\x15\x49\x6e\x73\x74\x61\x6e\x63\x65\x56\x61\x72\x69\x61\x62\x6c\x65\x45\x72\x72\x6f\x72\x02\x00\x00\x00\x09\x09\x00\x00\x00\x10\x55\x6e\x73\x75"
"\x70\x70\x6f\x72\x74\x65\x64\x45\x72\x72\x6f\x72\x02\x00\x00\x00\x09\x09\x00\x00\x00\x0e\x52\x65\x64\x65\x66\x69\x6e\x65\x64\x45\x72\x72\x6f\x72\x02\x00\x00\x00\x09\x09\x00\x00\x00\x12\x41\x63\x63\x65\x73\x73\x69\x62\x69\x6c\x69\x74\x79\x45\x72\x72\x6f\x72"
"\x02\x00\x00\x00\x09\x09\x00\x00\x00\x0f\x41\x73\x73\x65\x72\x74\x69\x6f\x6e\x46\x61\x69\x6c\x65\x64\x02\x00\x00\x00\x09\x09\x00\x00\x00\x0a\x69\x6e\x69\x74\x69\x61\x6c\x69\x7a\x65\x09\x00\x00\x00\x07\x6d\x65\x73\x73\x61\x67\x65\x09\x00\x00\x00\x06\x65\x72"
"\x72\x6f\x72\x73\x09\x00\x00\x00\x04\x6a\x6f\x69\x6e\x02\x00\x00\x00\x16\x09\x00\x00\x00\x0c\x43\x6f\x6d\x70\x69\x6c\x65\x45\x72\x72\x6f\x72\x09\x00\x00\x00\x06\x76\x61\x6c\x75\x65\x73\x0a\x00\x00\x00\x03\x03\x09\x00\x00\x00\x02\x09\x0a\x00\x09\x00\x00\x00"
"\x14\x6c\x69\x62\x3a\x3a\x62\x75\x69\x6c\x74\x69\x6e\x3a\x3a\x46\x6f\x72\x6d\x61\x74\x0b\x00\x00\x00\x02\x09\x00\x00\x00\x11\x6c\x69\x62\x3a\x3a\x62\x75\x69\x6c\x74\x69\x6e\x3a\x3a\x41\x6e\x79\x03\x02\x00\x00\x00\x1f\x09\x00\x00\x00\x05\x25\x73\x0a\x25\x73"
""
)->call();
}


}
